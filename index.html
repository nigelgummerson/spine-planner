<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spinal Surgical Planner V38 - Leeds Teaching Hospitals</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Istok+Web:wght@400;700&family=Noto+Sans:wght@400;700&family=Noto+Serif:wght@700&display=swap" rel="stylesheet">

    <style>
        /* BASE STYLES */
        body { font-family: 'Noto Sans', sans-serif; overflow: hidden; background-color: #f1f5f9; }
        .serif { font-family: 'Noto Serif', serif; }
        .font-leeds { font-family: 'Istok Web', sans-serif; }
        .no-select { user-select: none; -webkit-user-select: none; }
        
        /* EXPORT CONTAINER */
        #export-container {
            width: 1485px; 
            height: 1050px; 
            background: white;
            margin: 0 auto;
            display: flex;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            flex-shrink: 0;
            transform-origin: top center; 
        }

        /* EDITABLE FIELDS */
        .editable-field {
            border-bottom: 1px dashed #cbd5e1;
            min-width: 100px;
            display: inline-block;
            color: #334155;
            padding: 2px 0; 
            outline: none;
            cursor: text;
            line-height: 1.4;
        }
        .editable-field:focus {
            border-bottom: 1px solid #0f172a;
            background-color: #f8fafc;
        }
        .editable-field:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Incognito Toggle Animation */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #ef4444;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #ef4444;
        }

        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="root" class="h-screen w-screen flex flex-col"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useLayoutEffect, useMemo } = React;

        // ==========================================
        // SECTION 0: DATA DEFINITIONS
        // ==========================================
        
        const DIAMETER_OPTIONS = [];
        for (let i = 3.5; i <= 10.5; i += 0.5) DIAMETER_OPTIONS.push(i.toFixed(1));

        const LENGTH_OPTIONS = [];
        for (let i = 10; i <= 35; i++) LENGTH_OPTIONS.push(i);
        for (let i = 40; i <= 100; i += 5) LENGTH_OPTIONS.push(i);

        const OSTEOTOMY_TYPES = [
            { id: 'Facet', label: 'Facet Joint release', shortLabel: 'Facet', schwab: 'Schwab Grade 1', desc: 'Inferior facet resection; joint capsule removal.', defaultAngle: '5' },
            { id: 'Ponte', label: 'Ponte / Smith Petersen', shortLabel: 'Ponte', schwab: 'Schwab Grade 2', desc: 'Complete facetectomy; ligamentum flavum + lamina.', defaultAngle: '10' },
            { id: 'PSO', label: 'Standard PSO', shortLabel: 'PSO', schwab: 'Schwab Grade 3', desc: 'Pedicle subtraction; partial body wedge.', defaultAngle: '25' },
            { id: 'ExtPSO', label: 'Extended PSO', shortLabel: 'Ext PSO', schwab: 'Schwab Grade 4', desc: 'PSO + resection of adjacent disc.', defaultAngle: '35' },
            { id: 'VCR', label: 'VCR', shortLabel: 'VCR', schwab: 'Schwab Grade 5', desc: 'Complete vertebral column resection.', defaultAngle: '40' },
            { id: 'ML-VCR', label: 'Multi-level VCR', shortLabel: 'ML VCR', schwab: 'Schwab Grade 6', desc: 'Resection of multiple vertebrae and discs.', defaultAngle: '0' }
        ];

        // ==========================================
        // SECTION 1: ICONS & ASSETS
        // ==========================================
        const IconTrash = () => (<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>);
        const IconDownload = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>);
        const IconCopy = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>);
        const IconUpload = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>);
        const IconSave = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>);
        const IconCC = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M10.8 9.5a2.5 2.5 0 0 0-1.3-.8"/><path d="M9.5 9.5c-.8.5-1.5 1.5-1.5 2.5s.7 2 1.5 2.5"/><path d="M14.2 9.5a2.5 2.5 0 0 0-1.3-.8"/><path d="M12.9 9.5c-.8.5-1.5 1.5-1.5 2.5s.7 2 1.5 2.5"/></svg>);
        const IconX = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const IconPDF = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>);
        const IconHelp = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
        
        // --- NEW (V37/38): CARDINAL ARROW GHOST ---
        const IconCardinal = () => (
            <svg viewBox="0 0 24 24" className="w-5 h-5 opacity-40 hover:opacity-100 transition-opacity text-emerald-600" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3v18"/><path d="M3 12h18"/><path d="M8 7l4-4 4 4"/><path d="M8 17l4 4 4-4"/><path d="M17 8l4 4-4 4"/><path d="M7 8l-4 4 4 4"/></svg>
        );

        // ==========================================
        // SECTION 2: UI COMPONENTS
        // ==========================================
        
        const LeedsTrustLogo = () => (
            <div className="flex flex-col items-center justify-center mt-4 mb-6 opacity-90 shrink-0">
                <span className="text-[10px] font-bold text-slate-500 uppercase mb-1">Clinic Location:</span>
                <div className="flex flex-col text-center">
                    <span className="font-leeds font-bold text-slate-800 text-lg leading-none tracking-tight">Leeds Teaching Hospitals</span>
                    <span className="font-leeds text-slate-500 text-xs leading-none mt-1">NHS Trust</span>
                </div>
            </div>
        );

        const CreditsFooter = () => (
            <div className="mt-auto pt-4 border-t border-slate-200 shrink-0">
                <div className="flex flex-col gap-2">
                    <p className="text-[10px] text-slate-500 leading-tight">
                        <span className="font-bold text-slate-800 block mb-1 text-[11px]">Leeds Spinal Surgery Planner V38</span>
                        Developed by:<br/>
                        <span className="font-bold text-slate-700">Nigel Gummerson FRCS (Tr & Orth)</span><br/>
                        and <span className="font-bold text-slate-700">Google Gemini</span>,<br/>
                        December 2025
                    </p>
                    <div className="flex items-start gap-1 text-[9px] text-slate-400 leading-tight">
                        <div className="mt-0.5"><IconCC /></div>
                        <span>Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" className="underline hover:text-slate-600">CC BY-NC-SA 4.0</a>.</span>
                    </div>
                </div>
            </div>
        );

        const ImplantInventory = ({ placements, tools, title }) => {
            const inventory = useMemo(() => {
                const counts = {};
                placements.forEach(p => {
                    const tool = tools.find(t => t.id === p.tool);
                    if (!tool || tool.type === 'force') return;
                    let key = tool.label;
                    if (p.data) {
                        if (typeof p.data === 'string' && tool.needsSize) { key = `${tool.label} (${p.data})`; } 
                        else if (p.tool === 'osteotomy' && typeof p.data === 'object') { key = `${p.data.shortLabel} (${p.data.angle}°)`; } 
                        else if (p.data !== 'Custom') { key = `${tool.label} ${p.data}`; }
                    }
                    counts[key] = (counts[key] || 0) + 1;
                });
                return counts;
            }, [placements, tools]);

            if (Object.keys(inventory).length === 0) return null;

            return (
                <div className="mt-6 border-t border-slate-200 pt-3 shrink-0">
                    <h3 className="text-[10px] font-bold text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-100 pb-1">{title} Inventory</h3>
                    <div className="overflow-hidden rounded border border-slate-200">
                        <table className="w-full text-[9px]">
                            <thead className="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                                <tr><th className="text-left px-2 py-1.5">Item / Correction</th><th className="text-right px-2 py-1.5 w-8">Qty</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {Object.entries(inventory).sort().map(([name, count]) => (
                                    <tr key={name} className="even:bg-slate-50/50"><td className="px-2 py-1 text-slate-700 font-medium">{name}</td><td className="px-2 py-1 text-right font-bold text-slate-900">{count}</td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MODAL 1: SCREW SIZE (V38: KEYBOARD SHORTCUTS) ---
        const ScrewModal = ({ isOpen, onClose, onConfirm, onDelete, initialData, initialTool, defaultDiameter, defaultLength }) => {
            if (!isOpen) return null;
            const [mode, setMode] = useState('standard');
            const [diameter, setDiameter] = useState(defaultDiameter);
            const [length, setLength] = useState(defaultLength);
            const [customText, setCustomText] = useState('');
            const [selectedType, setSelectedType] = useState(initialTool || 'polyaxial');

            useEffect(() => {
                if (isOpen) {
                    if (initialTool) setSelectedType(initialTool);
                    if (initialData && typeof initialData === 'string') {
                         if (initialData === "Custom") { setMode('custom'); } 
                         else if (initialData.includes('x')) { const parts = initialData.split(' x '); if (parts.length === 2) { setMode('standard'); setDiameter(parts[0]); setLength(parts[1]); } else { setMode('custom'); setCustomText(initialData); } } 
                         else { setMode('standard'); }
                    } else if (initialData === null && initialData !== undefined) { setMode('none'); } 
                    else { setMode('standard'); setDiameter(defaultDiameter); setLength(defaultLength); setCustomText(''); }
                }
            }, [isOpen, initialData, initialTool, defaultDiameter, defaultLength]);

            // KEYBOARD LISTENER
            useEffect(() => {
                if (!isOpen) return;
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleSubmit();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        onClose();
                    } else if ((e.key === 'Delete' || e.key === 'Backspace') && initialData !== undefined) {
                        // Safety: Only delete if not typing in text box (checking active element)
                        if (document.activeElement.tagName !== 'INPUT') {
                            e.preventDefault();
                            onDelete();
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isOpen, mode, diameter, length, customText, selectedType, initialData]); // Dependencies for submit

            const handleSubmit = () => { let finalSize = null; if (mode === 'custom') finalSize = customText || "Custom"; else if (mode === 'standard') finalSize = `${diameter} x ${length}`; onConfirm(finalSize, { diameter, length }, selectedType); onClose(); };
            const isEditing = initialData !== undefined;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4 animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-sm overflow-hidden">
                        <div className="bg-slate-900 text-white px-4 py-3 flex justify-between items-center"><h3 className="font-bold text-sm">{isEditing ? 'Edit Screw' : 'Select Screw'}</h3><button onClick={onClose} className="hover:text-red-400"><IconX /></button></div>
                        <div className="p-6">
                            <div className="flex bg-slate-100 p-1 rounded mb-6">{['monoaxial', 'polyaxial', 'uniplanar'].map(t => (<button key={t} onClick={() => setSelectedType(t)} className={`flex-1 py-1 text-[10px] font-bold uppercase rounded transition-all ${selectedType === t ? 'bg-white shadow text-slate-900' : 'text-slate-400 hover:text-slate-600'}`}>{t.replace('axial','')}</button>))}</div>
                            <div className="flex gap-2 mb-4"><button onClick={() => setMode('standard')} className={`flex-1 py-1 text-xs font-bold rounded border ${mode === 'standard' ? 'bg-amber-500 text-slate-900 border-amber-600' : 'bg-slate-100 text-slate-500 border-slate-200'}`}>Standard</button><button onClick={() => setMode('custom')} className={`flex-1 py-1 text-xs font-bold rounded border ${mode === 'custom' ? 'bg-amber-500 text-slate-900 border-amber-600' : 'bg-slate-100 text-slate-500 border-slate-200'}`}>Custom</button><button onClick={() => setMode('none')} className={`flex-1 py-1 text-xs font-bold rounded border ${mode === 'none' ? 'bg-amber-500 text-slate-900 border-amber-600' : 'bg-slate-100 text-slate-500 border-slate-200'}`}>No Size</button></div>
                            {mode === 'standard' && (<div className="space-y-4"><div className="grid grid-cols-4 gap-2"><select value={diameter} onChange={(e) => setDiameter(e.target.value)} className="col-span-4 w-full p-2 border border-slate-300 rounded bg-slate-50 text-lg font-mono focus:border-amber-500 outline-none">{DIAMETER_OPTIONS.map(d => <option key={d} value={d}>{d} mm</option>)}</select></div><select value={length} onChange={(e) => setLength(e.target.value)} className="w-full p-2 border border-slate-300 rounded bg-slate-50 text-lg font-mono focus:border-amber-500 outline-none">{LENGTH_OPTIONS.map(l => <option key={l} value={l}>{l} mm</option>)}</select></div>)}
                            {mode === 'custom' && <input type="text" value={customText} onChange={(e) => setCustomText(e.target.value)} placeholder="e.g. 8.0 x 110" className="w-full p-2 border border-slate-300 rounded bg-slate-50 text-lg focus:border-amber-500 outline-none" autoFocus />}
                            {mode === 'none' && <div className="text-center py-6 text-slate-400 text-sm italic">Icon only. No label.</div>}
                        </div>
                        <div className="bg-slate-50 px-4 py-3 flex justify-between border-t border-slate-100">{isEditing ? <button onClick={onDelete} className="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-sm font-bold flex gap-1 items-center" title="Shortcut: Delete"><IconTrash/> Remove</button> : <div></div>}<div className="flex gap-2"><button onClick={onClose} className="px-4 py-2 rounded text-slate-500 hover:bg-slate-200 text-sm font-bold" title="Shortcut: Esc">Cancel</button><button onClick={handleSubmit} className="px-6 py-2 rounded bg-slate-800 text-white hover:bg-slate-700 text-sm font-bold shadow-lg" title="Shortcut: Enter">Confirm</button></div></div>
                    </div>
                </div>
            );
        };

        const OsteotomyModal = ({ isOpen, onClose, onConfirm, onDelete, initialData, defaultType, defaultAngle }) => {
            if (!isOpen) return null;
            const [type, setType] = useState(defaultType || 'PSO');
            const [angle, setAngle] = useState(defaultAngle || '25');
            useEffect(() => {
                if (isOpen) { if (initialData && typeof initialData === 'object') { setType(initialData.type); setAngle(initialData.angle); } else { setType(defaultType || 'PSO'); setAngle(defaultAngle || '25'); } }
            }, [isOpen, initialData, defaultType, defaultAngle]);
            
            // KEYBOARD LISTENER
            useEffect(() => {
                if (!isOpen) return;
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); handleSubmit(); }
                    else if (e.key === 'Escape') { e.preventDefault(); onClose(); }
                    else if ((e.key === 'Delete' || e.key === 'Backspace') && initialData) { if(document.activeElement.tagName !== 'INPUT') { e.preventDefault(); onDelete(); } }
                };
                window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isOpen, type, angle, initialData]);

            const selectedDef = OSTEOTOMY_TYPES.find(t => t.id === type) || OSTEOTOMY_TYPES[0];
            const handleTypeChange = (e) => { const newTypeID = e.target.value; setType(newTypeID); const newDef = OSTEOTOMY_TYPES.find(t => t.id === newTypeID); if (newDef) setAngle(newDef.defaultAngle); };
            const handleSubmit = () => { onConfirm({ type, angle, shortLabel: selectedDef.shortLabel }); onClose(); };
            const isEditing = !!initialData;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4 animate-[fadeIn_0.2s_ease-out]"><div className="bg-white rounded-lg shadow-2xl w-full max-w-sm overflow-hidden"><div className="bg-red-800 text-white px-4 py-3 flex justify-between items-center"><h3 className="font-bold text-sm">{isEditing ? 'Edit Osteotomy' : 'Plan Osteotomy'}</h3><button onClick={onClose} className="hover:text-red-200"><IconX /></button></div><div className="p-6 space-y-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Osteotomy Type</label><select value={type} onChange={handleTypeChange} className="w-full p-2 border border-slate-300 rounded bg-slate-50 text-sm font-bold text-slate-800 focus:border-red-500 outline-none">{OSTEOTOMY_TYPES.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}</select></div><div className="bg-red-50 border border-red-100 rounded p-3 text-xs"><div className="font-bold text-red-800 uppercase tracking-wider mb-1">{selectedDef.schwab}</div><div className="text-red-600 mb-2">{selectedDef.desc}</div></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Correction Angle (°)</label><div className="flex items-center gap-2"><input type="number" value={angle} onChange={(e) => setAngle(e.target.value)} className="w-24 p-2 border border-slate-300 rounded bg-slate-50 text-lg font-mono focus:border-red-500 outline-none text-center" /><span className="font-serif italic text-slate-400 text-sm">degrees</span></div></div></div><div className="bg-slate-50 px-4 py-3 flex justify-between border-t border-slate-100">{isEditing ? <button onClick={onDelete} className="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-sm font-bold flex gap-1 items-center" title="Shortcut: Delete"><IconTrash/> Remove</button> : <div></div>}<div className="flex gap-2"><button onClick={onClose} className="px-4 py-2 rounded text-slate-500 hover:bg-slate-200 text-sm font-bold" title="Shortcut: Esc">Cancel</button><button onClick={handleSubmit} className="px-6 py-2 rounded bg-red-800 text-white hover:bg-red-700 text-sm font-bold shadow-lg" title="Shortcut: Enter">Confirm</button></div></div></div></div>
            );
        };

        const HelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4 animate-[fadeIn_0.2s_ease-out]" onClick={onClose}><div className="bg-white rounded-lg shadow-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}><div className="bg-slate-800 text-white px-4 py-3 flex justify-between items-center"><h3 className="font-bold text-sm">Spinal Planner Help Guide</h3><button onClick={onClose} className="hover:text-slate-300"><IconX /></button></div><div className="p-6 space-y-6 overflow-y-auto max-h-[80vh]"><div className="flex gap-4"><div className="min-w-[40px] pt-1"><div className="w-8 h-4 rounded-full border border-red-500 bg-white relative"><div className="absolute right-0 top-0 w-3.5 h-3.5 bg-red-500 rounded-full"></div></div></div><div><h4 className="font-bold text-slate-800 text-sm mb-1">Session Mode (Incognito)</h4><p className="text-xs text-slate-600 leading-relaxed">When enabled (Red), your data is <strong>NOT saved</strong> to this computer's browser storage. Use this on shared or public NHS computers to ensure patient data is cleared when you close the tab. <br/><br/>When disabled (Grey), your work auto-saves locally so you can resume later.</p></div></div><div className="flex gap-4"><div className="min-w-[40px] pt-1"><div className="bg-slate-700 text-white px-2 py-1 rounded text-[10px] font-bold inline-block"><IconCopy /></div></div><div><h4 className="font-bold text-slate-800 text-sm mb-1">Copy Plan</h4><p className="text-xs text-slate-600 leading-relaxed">Copies everything from your "Pre-Op" plan to the "Post-Op" chart. Use this after surgery to start your record with what you planned, then just adjust what changed.</p></div></div><div className="flex gap-4"><div className="min-w-[40px] pt-1"><div className="bg-white text-slate-800 border border-slate-300 px-2 py-1 rounded text-[10px] font-bold inline-block"><IconPDF /></div></div><div><h4 className="font-bold text-slate-800 text-sm mb-1">Export PDF vs Image</h4><p className="text-xs text-slate-600 leading-relaxed"><strong>Export Image:</strong> Downloads a JPG file. Good for PowerPoint or email.<br/><strong>Export PDF:</strong> Downloads a high-quality PDF document. Good for uploading to PPM/EHR or printing.</p></div></div></div><div className="bg-slate-50 px-4 py-3 text-right"><button onClick={onClose} className="px-4 py-2 rounded bg-slate-800 text-white hover:bg-slate-700 text-sm font-bold">Close</button></div></div></div>
            );
        };

        const formatDate = (isoString) => {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return isoString;
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        };

        const REGIONS = { C: { height: 28, color: '#f1f5f9' }, T: { height: 36, color: '#e2e8f0' }, L: { height: 46, color: '#cbd5e1' }, S: { height: 52, color: '#94a3b8' }, Pelvis: { height: 54, color: '#94a3b8' } };
        
        // --- V38: NEW FORCE ICONS (VERTICAL/ROTATIONAL) ---
        const InstrumentIcon = ({ type, className = "w-5 h-5", color = "black" }) => {
            const strokeWidth = 2.5; const HookBase = ({ direction, label }) => (<svg viewBox="0 0 40 24" className="w-full h-full">{direction === 'up' ? <path d="M12 18V6m0 0l-4 4m4-4l4 4m-8 12h8" stroke={color} fill="none" strokeWidth={strokeWidth} /> : <path d="M12 6v12m0 0l-4-4m4 4l4-4m-8-12h8" stroke={color} fill="none" strokeWidth={strokeWidth} />}<text x="22" y="17" fontSize="14" fontWeight="bold" fontFamily="serif" fill={color}>{label}</text></svg>);
            switch (type) {
                // ... Implants ...
                case 'monoaxial': return <svg viewBox="0 0 24 24" className={className} stroke={color} fill="none" strokeWidth={strokeWidth}><circle cx="12" cy="12" r="9" /></svg>;
                case 'polyaxial': return <svg viewBox="0 0 24 24" className={className} stroke={color} fill="none" strokeWidth={strokeWidth}><circle cx="12" cy="12" r="9" /><path d="M7 7l10 10M17 7l-10 10" /></svg>;
                case 'uniplanar': return <svg viewBox="0 0 24 24" className={className} stroke={color} fill="none" strokeWidth={strokeWidth}><circle cx="12" cy="12" r="9" /><path d="M12 3v18" /></svg>;
                case 'pedicle_hook': return <div className={className}><HookBase direction="up" label="P" /></div>;
                case 'tp_hook': return <div className={className}><HookBase direction="down" label="TP" /></div>;
                case 'sl_hook': return <div className={className}><HookBase direction="down" label="SL" /></div>;
                case 'il_hook': return <div className={className}><HookBase direction="up" label="IL" /></div>;
                case 'connector': return <svg viewBox="0 0 40 10" className={className} stroke={color} fill="none" strokeWidth="2"><line x1="2" y1="5" x2="38" y2="5" strokeWidth="3" /><circle cx="2" cy="5" r="2" fill={color} /><circle cx="38" cy="5" r="2" fill={color} /></svg>;
                case 'unstable': return <svg viewBox="0 0 24 24" className={`${className} bg-white rounded border border-red-100 shadow-sm`} fill="none" stroke="#dc2626" strokeWidth="2.5"><path d="M2 12 L6 8 L10 16 L14 8 L18 16 L22 12" strokeLinecap="round" strokeLinejoin="round" /></svg>;
                case 'osteotomy': return <svg viewBox="0 0 24 24" className={className} stroke={color} fill="none" strokeWidth={strokeWidth}><path d="M2 12h20M12 2l10 10-10 10L2 12z" fill="#dc2626" opacity="0.8" /></svg>;
                
                // --- V38 FORCES ---
                case 'translate_left': return <svg viewBox="0 0 24 24" className={className} fill="#059669" stroke="none"><path d="M20 12H4M4 12l8-8M4 12l8 8" stroke="#059669" strokeWidth="4" fill="none" strokeLinecap="round" strokeLinejoin="round"/></svg>; 
                case 'translate_right': return <svg viewBox="0 0 24 24" className={className} fill="#059669" stroke="none"><path d="M4 12h16M20 12l-8-8M20 12l-8 8" stroke="#059669" strokeWidth="4" fill="none" strokeLinecap="round" strokeLinejoin="round"/></svg>; 
                case 'derotate_cw': return <svg viewBox="0 0 24 24" className={className} stroke="#059669" fill="none" strokeWidth="2.5"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /></svg>;
                case 'derotate_ccw': return <svg viewBox="0 0 24 24" className={className} stroke="#059669" fill="none" strokeWidth="2.5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></svg>;
                case 'compression': return <svg viewBox="0 0 24 24" className={className} stroke="#059669" fill="none" strokeWidth="3"><path d="M12 2v8m-4-4 4 4 4-4" /><path d="M12 22v-8m4 4-4-4-4 4" /></svg>; // V38: Vertical Converging
                case 'distraction': return <svg viewBox="0 0 24 24" className={className} stroke="#059669" fill="none" strokeWidth="3"><path d="M12 10V2m4 4-4-4-4 4" /><path d="M12 14v8m-4-4 4 4 4-4" /></svg>; // V38: Vertical Diverging
                default: return null;
            }
        };

        const SpineVertebra = ({ label, type, height }) => {
            const common = { fill: REGIONS[type].color, stroke: "#475569", strokeWidth: "1.5" };
            return (
                <svg viewBox={`0 0 160 ${height}`} className="w-[160px] block" style={{height: `${height}px`}} overflow="visible"><line x1="80" y1="-2" x2="80" y2={height + 2} stroke="#cbd5e1" strokeDasharray="3 3" /><g>{type === 'C' && <path d="M65,6 Q80,2 95,6 L95,22 Q80,26 65,22 Z" transform={`translate(0, 0) scale(1, ${height/24})`} {...common} />}{type === 'T' && <g><path d="M60,10 Q80,4 100,10 L105,27 Q80,33 55,27 Z" transform={`scale(1, ${height/32})`} {...common} /><path d="M55,13 L45,11" stroke="#64748b" strokeWidth="2" /><path d="M105,13 L115,11" stroke="#64748b" strokeWidth="2" /></g>}{type === 'L' && <g><path d="M55,8 Q80,2 105,8 L110,33 Q80,38 50,33 Z" transform={`scale(1, ${height/38})`} {...common} /><path d="M50,16 L35,20" stroke="#64748b" strokeWidth="3" /><path d="M110,16 L125,20" stroke="#64748b" strokeWidth="3" /></g>}{type === 'S' && <path d="M40,8 Q80,2 120,8 L100,43 Q80,53 60,43 Z" transform={`scale(1, ${height/48})`} {...common} />}{type === 'Pelvis' && <path d="M20,5 Q80,20 140,5 L130,40 Q80,50 30,40 Z" transform={`scale(1, ${height/45})`} {...common} opacity="0.6" />}</g><text x="80" y={height/2} dominantBaseline="middle" textAnchor="middle" fontSize="10" fontWeight="bold" fill="#334155" className="font-sans pointer-events-none select-none">{label}</text></svg>
            );
        };

        const LevelRow = ({ level, placements, onZoneClick, tools, onPlacementClick, readOnly, showForces }) => {
            const getItems = (z) => placements.filter(p => p.levelId === level.id && p.zone === z);
            
            // --- GHOST TARGET: CARDINAL FOR FORCES ---
            const GhostTarget = ({ type }) => {
                if (type === 'force') return <div className="flex items-center justify-center h-full w-full"><IconCardinal /></div>;
                return (<div className="w-6 h-6 rounded-full border-2 border-slate-300 border-dashed flex items-center justify-center opacity-40 hover:opacity-100 hover:border-amber-400 hover:bg-amber-50 transition-all"><div className="w-1 h-1 bg-slate-300 rounded-full"></div></div>);
            };

            const ZoneContent = ({ zone, align }) => {
                const items = getItems(zone);
                const hasItems = items.length > 0;
                const justifyClass = align === 'right' ? 'justify-start pl-1' : (align === 'center' ? 'justify-center' : 'justify-end pr-1');
                const isForceZone = zone.startsWith('force');
                return (
                    <div className={`flex items-center gap-1 h-full ${justifyClass} relative`}>{!hasItems && !readOnly && (zone === 'left' || zone === 'right' || isForceZone) && <GhostTarget type={isForceZone ? 'force' : 'screw'} />}
                        {items.map(p => { const tool = tools.find(t => t.id === p.tool); const isOsteo = p.tool === 'osteotomy'; let displayLabel = p.data; let angle = null; if (isOsteo && typeof p.data === 'object') { displayLabel = p.data.shortLabel || p.data.type; angle = p.data.angle; } return (<div key={p.id} className="relative group flex items-center gap-1">{align === 'left' && p.data && <span className="text-[18px] font-mono font-bold text-slate-700 bg-white/80 px-1 rounded whitespace-nowrap">{isOsteo ? `${displayLabel} ${angle}°` : displayLabel}</span>}<div className={`${isOsteo ? 'w-8 h-8' : 'w-6 h-6'} ${!readOnly ? 'cursor-pointer hover:scale-110 transition-transform' : ''}`} onClick={(e) => { e.stopPropagation(); !readOnly && onPlacementClick(p); }}><InstrumentIcon type={tool?.icon} className="w-full h-full drop-shadow-sm text-slate-900" />{!readOnly && <div className="hidden group-hover:block absolute -top-1 -right-1 bg-amber-500 rounded-full w-2 h-2" />}</div>{align === 'right' && p.data && <span className="text-[18px] font-mono font-bold text-slate-700 bg-white/80 px-1 rounded whitespace-nowrap">{isOsteo ? `${displayLabel} ${angle}°` : displayLabel}</span>}</div>); })}
                    </div>
                );
            };

            return (
                <div className="flex w-full relative" style={{ height: `${REGIONS[level.type].height}px` }}>
                    <div className="absolute bottom-0 left-0 right-0 border-b border-slate-100 w-full z-0 pointer-events-none"></div>
                    {/* VISUAL TINT FOR FORCE COLUMNS (V34) */}
                    <div className={`w-10 border-r border-slate-100/50 bg-emerald-50/20 ${!readOnly ? 'hover:bg-emerald-50 cursor-crosshair' : ''}`} onClick={() => !readOnly && onZoneClick(level.id, 'force_left')}><ZoneContent zone="force_left" align="center"/></div>
                    <div className={`flex-1 ${!readOnly ? 'hover:bg-blue-50/50 cursor-crosshair' : ''}`} onClick={() => !readOnly && onZoneClick(level.id, 'left')}><ZoneContent zone="left" align="left"/></div>
                    <div className={`w-[160px] relative flex justify-center shrink-0 z-10 ${!readOnly ? 'hover:brightness-95 cursor-pointer' : ''}`} onClick={() => !readOnly && onZoneClick(level.id, 'mid')}><SpineVertebra label={level.id} type={level.type} height={REGIONS[level.type].height} /><div className="absolute inset-0 flex items-center justify-center pointer-events-none">{getItems('mid').map(p => { const tool = tools.find(t => t.id === p.tool); let displayLabel = ''; let angle = ''; if (p.tool === 'osteotomy' && typeof p.data === 'object') { displayLabel = p.data.shortLabel || p.data.type; angle = p.data.angle; } return (<div key={p.id} className="pointer-events-auto relative group" onClick={(e) => { e.stopPropagation(); !readOnly && onPlacementClick(p); }}><InstrumentIcon type={tool?.icon} className={`${p.tool==='connector'?'w-24 h-6':'w-10 h-10'} drop-shadow-md text-slate-900`} />{p.tool === 'osteotomy' && p.data && (<div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white/90 border border-red-200 text-red-800 text-[18px] px-1 rounded shadow-sm whitespace-nowrap z-20">{displayLabel} {angle}°</div>)}</div>); })}</div></div>
                    <div className={`flex-1 ${!readOnly ? 'hover:bg-blue-50/50 cursor-crosshair' : ''}`} onClick={() => !readOnly && onZoneClick(level.id, 'right')}><ZoneContent zone="right" align="right"/></div>
                    <div className={`w-10 border-l border-slate-100/50 bg-emerald-50/20 ${!readOnly ? 'hover:bg-emerald-50 cursor-crosshair' : ''}`} onClick={() => !readOnly && onZoneClick(level.id, 'force_right')}><ZoneContent zone="force_right" align="center"/></div>
                </div>
            );
        };

        const ChartPaper = ({ title, placements, onZoneClick, onPlacementClick, tools, readOnly, levels, showForces }) => (
            <div className="flex-1 flex flex-col h-full border-l border-slate-200 bg-white relative"><div className="p-2 bg-slate-50 border-b border-slate-200 text-center font-bold text-sm text-slate-800 font-leeds uppercase tracking-wider">{title}</div><div className="flex-1 relative flex flex-col pt-8 px-2"><div className="flex w-full absolute top-1 left-0 right-0 px-2 text-[9px] font-bold text-slate-400 uppercase tracking-tighter text-center pointer-events-none z-10"><div className="w-10 text-emerald-600/50">{showForces ? 'Force' : ''}</div><div className="flex-1 text-right pr-4">Left</div><div className="w-[160px]"></div><div className="flex-1 text-left pl-4">Right</div><div className="w-10 text-emerald-600/50">{showForces ? 'Force' : ''}</div></div><div className="flex flex-col w-full relative">{levels.map(lvl => <LevelRow key={lvl.id} level={lvl} placements={placements} onZoneClick={onZoneClick} onPlacementClick={onPlacementClick} tools={tools} readOnly={readOnly} showForces={showForces} />)}</div></div></div>
        );

        // ==========================================
        // SECTION 4: MAIN APP CONTROLLER
        // ==========================================
        const App = () => {
            const [selectedTool, setSelectedTool] = useState('polyaxial');
            const [activeChart, setActiveChart] = useState('planned'); 
            const [plannedPlacements, setPlannedPlacements] = useState([]);
            const [completedPlacements, setCompletedPlacements] = useState([]);
            const [patientData, setPatientData] = useState({ name: '', id: '', surgeon: '', date: new Date().toISOString().split('T')[0] });
            const [showCervical, setShowCervical] = useState(false); 
            const [scale, setScale] = useState(1);
            const [incognitoMode, setIncognitoMode] = useState(false);
            const [isEditingDate, setIsEditingDate] = useState(false);
            const [hasLoaded, setHasLoaded] = useState(false);
            const [screwModalOpen, setScrewModalOpen] = useState(false);
            const [osteoModalOpen, setOsteoModalOpen] = useState(false);
            const [helpModalOpen, setHelpModalOpen] = useState(false);
            const [pendingPlacement, setPendingPlacement] = useState(null);
            const [editingPlacementId, setEditingPlacementId] = useState(null);
            const [editingData, setEditingData] = useState(null);
            const [editingTool, setEditingTool] = useState(null);
            const [defaultDiameter, setDefaultDiameter] = useState('6.5');
            const [defaultLength, setDefaultLength] = useState('45');
            const [defaultOsteoType, setDefaultOsteoType] = useState('PSO');
            const [defaultOsteoAngle, setDefaultOsteoAngle] = useState('25');
            
            const exportRef = useRef(null);
            const containerWrapperRef = useRef(null);
            const fileInputRef = useRef(null);

            const levels = useMemo(() => {
                const lvls = [];
                if (showCervical) ['C1','C2','C3','C4','C5','C6','C7'].forEach(l => lvls.push({ id:l, type:'C' }));
                ['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'].forEach(l => lvls.push({ id:l, type:'T' }));
                ['L1','L2','L3','L4','L5'].forEach(l => lvls.push({ id:l, type:'L' }));
                lvls.push({ id:'S1', type:'S' });
                lvls.push({ id:'Pelvis', type:'Pelvis' });
                return lvls;
            }, [showCervical]);

            // AUTO-LOAD
            useEffect(() => {
                const saved = localStorage.getItem('leeds_spine_planner_data_v28');
                if (saved) {
                    try { const parsed = JSON.parse(saved); if (parsed.planned) setPlannedPlacements(parsed.planned); if (parsed.completed) setCompletedPlacements(parsed.completed); if (parsed.patient) setPatientData(parsed.patient); if (parsed.showCervical !== undefined) setShowCervical(parsed.showCervical); } catch (e) { console.error("Data load error"); }
                }
                setHasLoaded(true);
            }, []);

            // AUTO-SAVE
            useEffect(() => {
                if (hasLoaded && !incognitoMode) { localStorage.setItem('leeds_spine_planner_data_v28', JSON.stringify({ planned: plannedPlacements, completed: completedPlacements, patient: patientData, showCervical })); }
                if (incognitoMode) localStorage.removeItem('leeds_spine_planner_data_v28');
            }, [plannedPlacements, completedPlacements, patientData, showCervical, hasLoaded, incognitoMode]);

            // RESIZE OBSERVER (V33 Fix: Auto-Size on Load)
            useEffect(() => {
                if (!containerWrapperRef.current) return;
                const observer = new ResizeObserver(() => {
                    if (containerWrapperRef.current && exportRef.current) {
                        const wrapperH = containerWrapperRef.current.clientHeight;
                        const wrapperW = containerWrapperRef.current.clientWidth;
                        setScale(Math.min((wrapperW - 40) / 1485, (wrapperH - 40) / 1050));
                    }
                });
                observer.observe(containerWrapperRef.current);
                return () => observer.disconnect();
            }, []);

            // V38: NEW FORCE TOOLBAR
            const tools = [
                { category: 'Screws', items: [ { id: 'monoaxial', label: 'Monoaxial', icon: 'monoaxial', needsSize: true, type: 'implant' }, { id: 'polyaxial', label: 'Polyaxial', icon: 'polyaxial', needsSize: true, type: 'implant' }, { id: 'uniplanar', label: 'Uniplanar', icon: 'uniplanar', needsSize: true, type: 'implant' }, ]},
                { category: 'Hooks', items: [ { id: 'pedicle_hook', label: 'Pedicle', icon: 'pedicle_hook', type: 'implant' }, { id: 'tp_hook', label: 'TP Hook', icon: 'tp_hook', type: 'implant' }, { id: 'sl_hook', label: 'Supra-laminar', icon: 'sl_hook', type: 'implant' }, { id: 'il_hook', label: 'Infra-laminar', icon: 'il_hook', type: 'implant' }, ]},
                { category: 'Midline', items: [ { id: 'connector', label: 'Crosslink', icon: 'connector', type: 'mid' }, { id: 'unstable', label: 'Unstable', icon: 'unstable', type: 'mid' }, { id: 'osteotomy', label: 'Osteotomy', icon: 'osteotomy', isOsteotomy: true, type: 'mid' }, ]},
                { category: 'Forces', items: [ 
                    { id: 'translate_left', label: 'Translate Left', icon: 'translate_left', type: 'force' },
                    { id: 'translate_right', label: 'Translate Right', icon: 'translate_right', type: 'force' },
                    { id: 'compression', label: 'Compress', icon: 'compression', type: 'force' },
                    { id: 'distraction', label: 'Distract', icon: 'distraction', type: 'force' },
                    { id: 'derotate_cw', label: 'Derotate ↻', icon: 'derotate_cw', type: 'force' },
                    { id: 'derotate_ccw', label: 'Derotate ↺', icon: 'derotate_ccw', type: 'force' },
                ]}
            ];
            const allTools = tools.flatMap(g => g.items);

            const handleZoneClick = (levelId, zone) => {
                const tool = allTools.find(t => t.id === selectedTool);
                
                if (tool.type === 'implant' && zone.startsWith('force')) return alert("Implants cannot be placed in force columns.");
                if (tool.type === 'force' && !zone.startsWith('force')) return alert("Forces must be placed in outer columns.");
                if (tool.type === 'implant' && zone === 'mid') return;
                if (tool.type === 'mid' && zone !== 'mid') return;

                if (tool.type === 'implant' && (zone === 'left' || zone === 'right')) {
                    const currentPlacements = activeChart === 'planned' ? plannedPlacements : completedPlacements;
                    const existing = currentPlacements.find(p => p.levelId === levelId && p.zone === zone);
                    if (existing) {
                        return alert("Only one implant allowed per side. Please remove the existing one first.");
                    }
                }

                if (tool.needsSize) { setPendingPlacement({ levelId, zone, tool: selectedTool }); setEditingPlacementId(null); setEditingData(undefined); setEditingTool(selectedTool); setScrewModalOpen(true); } 
                else if (tool.isOsteotomy) { setPendingPlacement({ levelId, zone, tool: selectedTool }); setEditingPlacementId(null); setEditingData(undefined); setOsteoModalOpen(true); } 
                else { addPlacement(levelId, zone, selectedTool, null); }
            };

            const handlePlacementClick = (p) => {
                const tool = allTools.find(t => t.id === p.tool);
                if (tool.needsSize) { setEditingPlacementId(p.id); setEditingData(p.data); setEditingTool(p.tool); setScrewModalOpen(true); } 
                else if (tool.isOsteotomy) { setEditingPlacementId(p.id); setEditingData(p.data); setOsteoModalOpen(true); } 
                else { removePlacement(p.id); }
            };

            const handleScrewConfirm = (sizeData, components, finalType) => {
                if(components) { setDefaultDiameter(components.diameter); setDefaultLength(components.length); }
                if (editingPlacementId) { updatePlacement(editingPlacementId, finalType, sizeData); setEditingPlacementId(null); } 
                else if (pendingPlacement) { addPlacement(pendingPlacement.levelId, pendingPlacement.zone, finalType, sizeData); setPendingPlacement(null); }
            };

            const handleOsteoConfirm = (data) => {
                setDefaultOsteoType(data.type); setDefaultOsteoAngle(data.angle);
                if (editingPlacementId) { updatePlacement(editingPlacementId, 'osteotomy', data); setEditingPlacementId(null); } 
                else if (pendingPlacement) { addPlacement(pendingPlacement.levelId, pendingPlacement.zone, 'osteotomy', data); setPendingPlacement(null); }
            };

            const addPlacement = (levelId, zone, tool, data) => { const newP = { id: Date.now(), levelId, zone, tool, data }; const setter = activeChart === 'planned' ? setPlannedPlacements : setCompletedPlacements; setter(prev => [...prev, newP]); };
            const updatePlacement = (id, tool, data) => { const updater = (prev) => prev.map(p => p.id === id ? { ...p, tool, data } : p); if (activeChart === 'planned') setPlannedPlacements(updater); else setCompletedPlacements(updater); };
            const removePlacement = (id) => { const filter = prev => prev.filter(p => p.id !== id); if (activeChart === 'planned') setPlannedPlacements(filter); else setCompletedPlacements(filter); setScrewModalOpen(false); setOsteoModalOpen(false); };

            const prepareExportCanvas = async () => {
                const element = exportRef.current;
                const cloneContainer = document.createElement('div');
                cloneContainer.style.position = 'absolute'; cloneContainer.style.top = '0'; cloneContainer.style.left = '0'; cloneContainer.style.zIndex = '-9999';
                document.body.appendChild(cloneContainer);
                const clone = element.cloneNode(true);
                clone.style.transform = 'none'; clone.style.margin = '0';
                cloneContainer.appendChild(clone);
                const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff', width: 1485, height: 1050, logging: false });
                document.body.removeChild(cloneContainer);
                return canvas;
            };

            const runExportJPG = async () => {
                const canvas = await prepareExportCanvas();
                const link = document.createElement('a'); link.download = `SpinePlan_${patientData.name || 'Patient'}.jpg`; link.href = canvas.toDataURL('image/jpeg', 0.9); link.click();
                if (incognitoMode) localStorage.removeItem('leeds_spine_planner_data_v28');
            };

            const runExportPDF = async () => {
                const canvas = await prepareExportCanvas();
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [1485, 1050] });
                pdf.addImage(imgData, 'JPEG', 0, 0, 1485, 1050);
                pdf.save(`SpinePlan_${patientData.name || 'Patient'}.pdf`);
                if (incognitoMode) localStorage.removeItem('leeds_spine_planner_data_v28');
            };

            const saveProjectJSON = () => {
                const data = { version: 38, patient: patientData, planned: plannedPlacements, completed: completedPlacements, showCervical, timestamp: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `SpineProject_${patientData.name || 'Unnamed'}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                if (incognitoMode) localStorage.removeItem('leeds_spine_planner_data_v28');
            };

            const loadProjectJSON = (e) => {
                const file = e.target.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try { const json = JSON.parse(ev.target.result); if(json.patient) setPatientData(json.patient); if(json.planned) setPlannedPlacements(json.planned); if(json.completed) setCompletedPlacements(json.completed); if(json.showCervical !== undefined) setShowCervical(json.showCervical); alert("Project Loaded Successfully."); } catch(err) { alert("Invalid File"); }
                };
                reader.readAsText(file); e.target.value = null;
            };

            const copyPlanToCompleted = () => {
                if (plannedPlacements.length === 0) return alert("No Pre-Op plan to copy.");
                if (completedPlacements.length > 0 && !confirm("Overwrite existing Post-Op construct?")) return;
                const copied = plannedPlacements.map((p,i) => ({...p, id: Date.now()+i}));
                setCompletedPlacements(copied);
                setActiveChart('completed');
            };

            return (
                <div className="h-full flex flex-col overflow-hidden">
                    <ScrewModal isOpen={screwModalOpen} onClose={() => setScrewModalOpen(false)} onConfirm={handleScrewConfirm} onDelete={() => removePlacement(editingPlacementId)} initialData={editingData} initialTool={editingTool} defaultDiameter={defaultDiameter} defaultLength={defaultLength} />
                    <OsteotomyModal isOpen={osteoModalOpen} onClose={() => setOsteoModalOpen(false)} onConfirm={handleOsteoConfirm} onDelete={() => removePlacement(editingPlacementId)} initialData={editingData} defaultType={defaultOsteoType} defaultAngle={defaultOsteoAngle} /> <HelpModal isOpen={helpModalOpen} onClose={() => setHelpModalOpen(false)} />

                    <header className="bg-slate-900 text-white p-2 flex justify-between items-center shadow-md z-30 shrink-0 no-print h-14">
                        <div className="flex items-center gap-4">
                            <h1 className="font-bold text-lg px-2">Leeds Spinal Planner V38</h1>
                            <div className="flex bg-slate-800 rounded p-1 text-sm border border-slate-700">
                                <button onClick={() => setActiveChart('planned')} className={`px-4 py-1 rounded transition-all ${activeChart==='planned'?'bg-amber-500 text-slate-900 font-bold':'text-slate-400 hover:text-white'}`} title="View Pre-Operative Plan">Pre-Op</button>
                                <button onClick={() => setActiveChart('completed')} className={`px-4 py-1 rounded transition-all ${activeChart==='completed'?'bg-amber-500 text-slate-900 font-bold':'text-slate-400 hover:text-white'}`} title="View Post-Operative Construct">Post-Op</button>
                            </div>
                            <button onClick={copyPlanToCompleted} className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs font-bold border border-slate-600 transition-colors" title="Copy all Pre-Op screws to Post-Op view"><IconCopy /> Copy Plan</button>
                        </div>
                        <div className="flex gap-4 items-center">
                            <button onClick={() => setHelpModalOpen(true)} className="text-slate-400 hover:text-white flex items-center justify-center transition-colors" title="Help Guide"><IconHelp /></button>
                            <div className="h-8 w-px bg-slate-700 mx-1"></div>
                            
                            <div className={`flex items-center gap-2 px-3 py-1 rounded border transition-colors ${incognitoMode ? 'bg-red-900/30 border-red-500/50' : 'bg-transparent border-transparent'}`} title="Enable to prevent saving data to this computer (for shared/public computers)">
                                <div className="relative inline-block w-8 h-4 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="incognito-toggle" className="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300" style={{ top: 0, left: 0 }} checked={incognitoMode} onChange={(e) => setIncognitoMode(e.target.checked)}/>
                                    <label htmlFor="incognito-toggle" className={`toggle-label block overflow-hidden h-4 rounded-full cursor-pointer border ${incognitoMode ? 'bg-red-600 border-red-600' : 'bg-slate-600 border-slate-600'}`}></label>
                                </div>
                                <div className="flex flex-col leading-none">
                                    <span className={`text-[10px] font-bold uppercase tracking-wider ${incognitoMode ? 'text-red-400' : 'text-slate-500'}`}>Session Mode</span>
                                </div>
                            </div>
                            <div className="h-8 w-px bg-slate-700 mx-1"></div>
                            
                            <input type="file" ref={fileInputRef} onChange={loadProjectJSON} className="hidden" accept=".json" />
                            <button onClick={() => fileInputRef.current.click()} className="text-slate-300 hover:text-white px-2 py-1.5 rounded flex gap-2 items-center text-xs font-bold transition-colors" title="Load saved .json project"><IconUpload /> Load</button>
                            <button onClick={saveProjectJSON} className="text-slate-300 hover:text-white px-2 py-1.5 rounded flex gap-2 items-center text-xs font-bold transition-colors" title="Save editable .json project"><IconSave /> Save</button>
                            
                            <div className="flex bg-white rounded overflow-hidden">
                                <button onClick={runExportJPG} className="text-slate-900 px-3 py-1.5 hover:bg-slate-200 text-sm border-r border-slate-200 flex items-center gap-1" title="Download Image (JPG)"><IconDownload /> JPG</button>
                                <button onClick={runExportPDF} className="text-slate-900 px-3 py-1.5 hover:bg-slate-200 text-sm flex items-center gap-1" title="Download PDF Document"><IconPDF /> PDF</button>
                            </div>

                            <button onClick={() => { if(confirm("Start New Patient? This will clear the current plan.")) { setPlannedPlacements([]); setCompletedPlacements([]); setPatientData({ name: '', id: '', surgeon: '', date: new Date().toISOString().split('T')[0] }); setActiveChart('planned'); } }} className="ml-2 text-red-400 hover:text-red-200 p-2" title="Clear All / New Patient"><IconTrash /></button>
                        </div>
                    </header>

                    <div className="flex-1 overflow-hidden bg-slate-200 flex relative">
                        <aside className="w-64 bg-slate-800 text-white flex flex-col border-r border-slate-700 z-20 overflow-y-auto no-print shadow-xl">
                            <div className="p-4 border-b border-slate-700 bg-slate-900"><label className="flex items-center gap-2 cursor-pointer select-none text-sm text-slate-300 hover:text-white"><input type="checkbox" checked={showCervical} onChange={e=>setShowCervical(e.target.checked)} className="w-4 h-4 rounded text-amber-500 focus:ring-amber-500"/> Show Cervical</label></div>
                            <div className="p-4 space-y-6">
                                {tools.map((g,i) => (<div key={i}><h3 className="text-[10px] uppercase font-bold text-slate-500 mb-2 tracking-widest">{g.category}</h3><div className="grid grid-cols-2 gap-2">{g.items.map(t => (<button key={t.id} onClick={() => setSelectedTool(t.id)} className={`p-2 rounded border flex flex-col items-center justify-center gap-1 transition-all text-xs ${selectedTool === t.id ? 'bg-amber-500 border-amber-600 text-slate-900 font-bold' : 'bg-slate-700 border-slate-600 hover:bg-slate-600 text-slate-200'}`}><InstrumentIcon type={t.icon} className="w-6 h-6 mb-1" color={selectedTool === t.id ? 'black' : 'white'} /><span className="text-center text-[10px]">{t.label}</span></button>))}</div></div>))}
                            </div>
                        </aside>

                        <div ref={containerWrapperRef} id="print-wrapper" className="flex-1 flex items-center justify-center p-8 bg-slate-300 overflow-hidden relative">
                            <div style={{ transform: `scale(${scale})` }}>
                                <div id="export-container" ref={exportRef}>
                                    <div className="w-[300px] bg-white border-r border-slate-300 flex flex-col p-8">
                                        <h2 className="font-leeds font-bold text-3xl text-slate-900 mb-4 border-b-4 border-slate-900 pb-2">Spinal Surgery</h2>
                                        
                                        {/* COMPACTED DEMOGRAPHICS & SCROLLABLE INVENTORY CONTAINER (V32: Increased Spacing) */}
                                        <div className="flex-1 flex flex-col overflow-y-auto min-h-0">
                                            <div className="space-y-3 text-sm shrink-0">
                                                <div><label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Patient Name</label><div className="editable-field w-full text-base font-serif" contentEditable suppressContentEditableWarning onBlur={e => setPatientData({...patientData, name: e.target.innerText})} placeholder="Click to enter...">{patientData.name}</div></div>
                                                <div><label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Patient ID</label><div className="editable-field w-full text-base font-mono" contentEditable suppressContentEditableWarning onBlur={e => setPatientData({...patientData, id: e.target.innerText})} placeholder="Click to enter...">{patientData.id}</div></div>
                                                <div><label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Surgeon</label><div className="editable-field w-full text-base" contentEditable suppressContentEditableWarning onBlur={e => setPatientData({...patientData, surgeon: e.target.innerText})} placeholder="Click to enter...">{patientData.surgeon}</div></div>
                                                <div><label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Date</label><div className="editable-field w-full text-base cursor-pointer" onClick={() => setIsEditingDate(true)}>{isEditingDate ? <input type="date" className="w-full text-sm border-b border-slate-800 bg-transparent outline-none py-0" value={patientData.date} autoFocus onBlur={()=>setIsEditingDate(false)} onChange={e=>setPatientData({...patientData, date:e.target.value})} /> : formatDate(patientData.date)}</div></div>
                                            </div>
                                            <ImplantInventory placements={activeChart === 'planned' ? plannedPlacements : completedPlacements} tools={allTools} title={activeChart === 'planned' ? 'Plan' : 'Construct'} />
                                            <LeedsTrustLogo />
                                        </div>
                                        <CreditsFooter />
                                    </div>
                                    <ChartPaper title="Pre-Operative Plan" placements={plannedPlacements} onZoneClick={handleZoneClick} onPlacementClick={handlePlacementClick} tools={allTools} readOnly={activeChart !== 'planned'} levels={levels} showForces={true} />
                                    <ChartPaper title="Surgical Construct" placements={completedPlacements} onZoneClick={handleZoneClick} onPlacementClick={handlePlacementClick} tools={allTools} readOnly={activeChart !== 'completed'} levels={levels} showForces={false} />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
